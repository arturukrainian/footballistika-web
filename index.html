<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Footballistika — профіль</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: radial-gradient(120% 120% at 10% 20%, #2b8a3e 0%, #0f1a16 55%, #0b0f0d 100%);
      --card: rgba(255, 255, 255, 0.06);
      --card-border: rgba(255, 255, 255, 0.12);
      --text: #e9f4ec;
      --muted: #a8c6b5;
      --accent: #9ef01a;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: var(--text);
      font-family: "Manrope", "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 24px;
    }

    .card {
      width: min(420px, 100%);
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 22px 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      display: grid;
      gap: 16px;
      animation: rise 400ms ease-out;
    }

    @keyframes rise {
      from {
        transform: translateY(12px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .avatar {
      width: 68px;
      height: 68px;
      border-radius: 20px;
      background: linear-gradient(135deg, #23392b, #1b2621);
      border: 1px solid var(--card-border);
      display: grid;
      place-items: center;
      color: var(--accent);
      font-weight: 700;
      font-size: 22px;
      overflow: hidden;
      position: relative;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .names {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .username {
      font-size: 18px;
      font-weight: 700;
    }

    .fullname {
      color: var(--muted);
      font-size: 14px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(158, 240, 26, 0.12);
      color: var(--accent);
      border: 1px solid rgba(158, 240, 26, 0.28);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      width: fit-content;
    }

    .section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .status {
      font-size: 14px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="header">
      <div class="avatar" id="avatar">
        <img id="avatarImg" alt="avatar">
        <span id="avatarFallback">TG</span>
      </div>
      <div class="names">
        <div class="username" id="username">@username</div>
        <div class="fullname" id="fullname">Ім'я з Telegram</div>
        <div class="pill" id="userid">id: —</div>
      </div>
    </div>

    <div class="section">
      <div class="hint">
        Дані беруться напряму з Telegram Web App через initData, без окремої реєстрації. В бекенд підпис <code>initData</code> треба валідувати токеном бота.
      </div>
      <div class="status" id="status">Очікую на Telegram Web App...</div>
    </div>
  </main>

  <script>
    const tg = window.Telegram?.WebApp;
    const statusEl = document.getElementById("status");
    const usernameEl = document.getElementById("username");
    const fullnameEl = document.getElementById("fullname");
    const userIdEl = document.getElementById("userid");
    const avatarImg = document.getElementById("avatarImg");
    const avatarFallback = document.getElementById("avatarFallback");

    function setFallbackInitials(user) {
      const first = (user.first_name || "").trim();
      const last = (user.last_name || "").trim();
      const initials = (first[0] || "") + (last[0] || "");
      avatarFallback.textContent = initials ? initials.toUpperCase() : "TG";
    }

    function getUserFromHash() {
      // location.hash може містити tgWebAppData="query_id=...&user=%7B...%7D&auth_date=...&hash=..."
      const rawHash = location.hash.startsWith("#") ? location.hash.slice(1) : location.hash;
      if (!rawHash) return null;
      const outer = new URLSearchParams(rawHash);
      const innerStr = outer.get("tgWebAppData");
      if (!innerStr) return null;
      const inner = new URLSearchParams(innerStr);
      const userStr = inner.get("user");
      if (!userStr) return null;
      try { return JSON.parse(decodeURIComponent(userStr)); } catch { return null; }
    }

    function getUser() {
      return tg?.initDataUnsafe?.user || getUserFromHash();
    }

    function renderUser(user) {
      const nameLabel = user.username ? `@${user.username}` : (user.first_name || user.last_name || `id${user.id}`);
      const fullLabel = [user.first_name, user.last_name].filter(Boolean).join(" ") || "Користувач Telegram";
      usernameEl.textContent = nameLabel;
      fullnameEl.textContent = fullLabel;
      userIdEl.textContent = `id: ${user.id}`;
      statusEl.textContent = "Дані підтягнуті з Telegram. На бекові валідуй initData перед збереженням профілю.";
      setFallbackInitials(user);
      if (user.photo_url) {
        avatarImg.src = user.photo_url;
        avatarImg.onload = () => { avatarImg.style.display = "block"; avatarFallback.style.display = "none"; };
        avatarImg.onerror = () => { avatarImg.style.display = "none"; avatarFallback.style.display = "block"; };
      } else {
        avatarImg.style.display = "none";
        avatarFallback.style.display = "block";
      }
    }

    (function boot() {
      if (!tg) {
        statusEl.textContent = "Запусти через кнопку Web App у Telegram.";
        return setFallbackInitials({});
      }
      tg.ready(); tg.expand();

      const user = getUser();

      if (!user) {
        const isMac = tg.platform === "macos";
        statusEl.textContent = isMac
          ? "Клієнт Telegram для macOS не передає user. Відкрий у мобільному Telegram або Telegram Desktop."
          : "Не бачу user у initData. Відкрий через кнопку бота (не напряму лінком).";
        return setFallbackInitials({});
      }
      renderUser(user);

      // (опційно) відіслати initData на бекенд для валідації
      const initData = tg.initData || (new URLSearchParams(location.hash.slice(1)).get("tgWebAppData") || "");
      if (initData) {
        fetch("/api/webapp/login", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ initData }).toString(),
          credentials: "include",
        }).catch(()=>{});
      }
    })();
  </script>
  <script>
    const tgDebug = window.Telegram?.WebApp;
    const statusElDebug = document.getElementById("status");

    function showDebug(msg, extra) {
      console.log(msg, extra);
      statusElDebug.textContent = msg + (extra ? " " + extra : "");
    }

    if (!tgDebug) {
      showDebug("Сторінка поза Telegram. Відкрий через кнопку в боті.");
    } else {
      tgDebug.ready(); tgDebug.expand();
      const sameHost =
        location.host === "footballistika-web.vercel.app";

      const info = `host=${location.host} tg.platform=${tgDebug.platform} initData.len=${(tgDebug.initData||"").length}`;
      if (!sameHost) {
        showDebug("Домен не збігається з /setdomain.", info);
      } else if (!tgDebug.initData || !tgDebug.initDataUnsafe?.user) {
        showDebug("initData порожній. Перевір /setdomain і відкриття через кнопку.", info);
      } else {
        showDebug("OK: initData є.", info);
      }
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Footballistika — профіль</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: radial-gradient(120% 120% at 10% 20%, #2b8a3e 0%, #0f1a16 55%, #0b0f0d 100%);
      --card: rgba(255, 255, 255, 0.06);
      --card-border: rgba(255, 255, 255, 0.12);
      --text: #e9f4ec;
      --muted: #a8c6b5;
      --accent: #9ef01a;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: var(--text);
      font-family: "Manrope", "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 24px;
    }

    .card {
      width: min(420px, 100%);
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 22px 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      display: grid;
      gap: 16px;
      animation: rise 400ms ease-out;
    }

    @keyframes rise {
      from {
        transform: translateY(12px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .avatar {
      width: 68px;
      height: 68px;
      border-radius: 20px;
      background: linear-gradient(135deg, #23392b, #1b2621);
      border: 1px solid var(--card-border);
      display: grid;
      place-items: center;
      color: var(--accent);
      font-weight: 700;
      font-size: 22px;
      overflow: hidden;
      position: relative;
    }

    .avatar-wrap {
      display: grid;
      place-items: center;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .names {
      display: grid;
      gap: 6px;
      text-align: center;
    }

    .display-name {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .stat {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 6px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 800;
      color: var(--text);
    }

    .stat-sub {
      font-size: 13px;
      color: var(--muted);
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .status {
      font-size: 14px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="avatar-wrap">
      <div class="avatar" id="avatar">
        <img id="avatarImg" alt="avatar">
        <span id="avatarFallback">TG</span>
      </div>
    </div>
    <div class="names">
      <div class="display-name" id="displayName">@username</div>
    </div>

    <div class="stats" id="stats">
      <div class="stat">
        <div class="stat-label">Якість прогнозів</div>
        <div class="stat-value" id="resultAccuracy">—%</div>
        <div class="stat-sub" id="predictionsCount">Прогнози: —</div>
      </div>
      <div class="stat">
        <div class="stat-label">Точність по голам</div>
        <div class="stat-value" id="goalAccuracy">—%</div>
      </div>
    </div>
    <div class="status" id="status"></div>
  </main>

  <script>
    const API_BASE = "https://footballistikaweb-production.up.railway.app"; // повний домен Railway
    const tg = window.Telegram?.WebApp;
    const statusEl = document.getElementById("status");
    const displayNameEl = document.getElementById("displayName");
    const avatarImg = document.getElementById("avatarImg");
    const avatarFallback = document.getElementById("avatarFallback");
    const resultAccuracyEl = document.getElementById("resultAccuracy");
    const goalAccuracyEl = document.getElementById("goalAccuracy");
    const predictionsCountEl = document.getElementById("predictionsCount");

    function setFallbackInitials(user) {
      const first = (user.first_name || "").trim();
      const last = (user.last_name || "").trim();
      const initials = (first[0] || "") + (last[0] || "");
      avatarFallback.textContent = initials ? initials.toUpperCase() : "TG";
    }

    function getUserFromHash() {
      // location.hash може містити tgWebAppData="query_id=...&user=%7B...%7D&auth_date=...&hash=..."
      const rawHash = location.hash.startsWith("#") ? location.hash.slice(1) : location.hash;
      if (!rawHash) return null;
      const outer = new URLSearchParams(rawHash);
      const innerStr = outer.get("tgWebAppData");
      if (!innerStr) return null;
      const inner = new URLSearchParams(innerStr);
      const userStr = inner.get("user");
      if (!userStr) return null;
      try { return JSON.parse(decodeURIComponent(userStr)); } catch { return null; }
    }

    function getUser() {
      return tg?.initDataUnsafe?.user || getUserFromHash();
    }

    function getInitDataRaw() {
      if (tg?.initData) return tg.initData;
      const hash = location.hash.startsWith("#") ? location.hash.slice(1) : location.hash;
      const outer = new URLSearchParams(hash);
      return outer.get("tgWebAppData") || "";
    }

    function renderUser(user) {
      const fullLabel = [user.first_name, user.last_name].filter(Boolean).join(" ");
      const nameLabel = fullLabel || (user.username ? `@${user.username}` : `id${user.id}`);
      displayNameEl.textContent = nameLabel;
      statusEl.textContent = "";
      setFallbackInitials(user);
      if (user.photo_url) {
        avatarImg.src = user.photo_url;
        avatarImg.onload = () => { avatarImg.style.display = "block"; avatarFallback.style.display = "none"; };
        avatarImg.onerror = () => { avatarImg.style.display = "none"; avatarFallback.style.display = "block"; };
      } else {
        avatarImg.style.display = "none";
        avatarFallback.style.display = "block";
      }
    }

    async function loadProfile(initData) {
      if (!initData) return;
      try {
        const res = await fetch(`${API_BASE}/api/webapp/profile`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ initData }).toString(),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "profile_failed");
        const stats = data.stats || {};
        predictionsCountEl.textContent = `Прогнози: ${stats.predictions ?? "0"}`;
        resultAccuracyEl.textContent = `${Number(stats.result_accuracy_percent || 0).toFixed(0)}%`;
        goalAccuracyEl.textContent = `${Number(stats.goal_accuracy_percent || 0).toFixed(0)}%`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = "";
      }
    }

    (function boot() {
      if (!tg) {
        statusEl.textContent = "Запусти через кнопку Web App у Telegram.";
        return setFallbackInitials({});
      }
      tg.ready(); tg.expand();

      const user = getUser();

      if (!user) {
        const isMac = tg.platform === "macos";
        statusEl.textContent = isMac
          ? "Клієнт Telegram для macOS не передає user. Відкрий у мобільному Telegram або Telegram Desktop."
          : "Не бачу user у initData. Відкрий через кнопку бота (не напряму лінком).";
        return setFallbackInitials({});
      }
      renderUser(user);

      const initData = getInitDataRaw();
      loadProfile(initData);
    })();
  </script>
  <script>
    const DEBUG = false; // ← вимикає повідомлення в інтерфейсі

    const tgDebug = window.Telegram?.WebApp;
    const statusElDebug = document.getElementById("status");

    function showDebug(msg, extra) {
      console.log(msg, extra);
      if (DEBUG && statusElDebug) {
        statusElDebug.textContent = msg + (extra ? " " + extra : "");
      }
    }

    if (!tgDebug) {
      showDebug("Сторінка поза Telegram. Відкрий через кнопку в боті.");
    } else {
      tgDebug.ready(); tgDebug.expand();
      const sameHost = location.host === "footballistika-web.vercel.app";

      const info = `host=${location.host} tg.platform=${tgDebug.platform} initData.len=${(tgDebug.initData||"").length}`;
      if (!sameHost) showDebug("Домен не збігається з /setdomain.", info);
      else if (!tgDebug.initData || !tgDebug.initDataUnsafe?.user) showDebug("initData порожній. Перевір /setdomain і відкриття через кнопку.", info);
      else showDebug("OK: initData є.", info);
    }
  </script>
</body>
</html>

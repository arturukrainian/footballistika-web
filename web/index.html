<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Footballistika — профіль</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: radial-gradient(120% 120% at 10% 20%, #2b8a3e 0%, #0f1a16 55%, #0b0f0d 100%);
      --card: rgba(255, 255, 255, 0.06);
      --card-border: rgba(255, 255, 255, 0.12);
      --text: #e9f4ec;
      --muted: #a8c6b5;
      --accent: #9ef01a;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: var(--text);
      font-family: "Manrope", "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 24px;
    }

    .card {
      width: min(420px, 100%);
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 22px 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      display: grid;
      gap: 16px;
      animation: rise 400ms ease-out;
    }

    @keyframes rise {
      from {
        transform: translateY(12px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .avatar {
      width: 68px;
      height: 68px;
      border-radius: 20px;
      background: linear-gradient(135deg, #23392b, #1b2621);
      border: 1px solid var(--card-border);
      display: grid;
      place-items: center;
      color: var(--accent);
      font-weight: 700;
      font-size: 22px;
      overflow: hidden;
      position: relative;
    }

    .avatar-wrap {
      display: grid;
      place-items: center;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .names {
      display: grid;
      gap: 6px;
      text-align: center;
    }

    .display-name {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--muted);
      letter-spacing: 0.2px;
    }

    .info-row {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      letter-spacing: 0.2px;
    }

    .section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .stats {
      display: grid;
      gap: 12px;
    }

    .stat {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 800;
      color: var(--text);
    }

    .progress {
      width: 100%;
      height: 10px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #9ef01a, #49c24d);
      border-radius: 999px;
      transition: width 800ms ease-out;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .status {
      font-size: 14px;
      color: var(--muted);
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .action-btn {
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 700;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #9ef01a, #4ed44b);
      color: #0f1a16;
      border-color: rgba(158, 240, 26, 0.5);
    }

    .action-btn:active {
      transform: translateY(1px);
    }

    .action-btn.active {
      border-color: #9ef01a;
      box-shadow: 0 14px 36px rgba(158, 240, 26, 0.22);
    }

    .tab-panel {
      display: grid;
      gap: 14px;
    }

    .hidden {
      display: none !important;
    }

    .panel {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 14px;
      display: grid;
      gap: 12px;
    }

    .panel-title {
      font-weight: 800;
      font-size: 16px;
      letter-spacing: 0.2px;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .carousel {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
    }

    .match-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 12px;
    }

    .match-title {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .score-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .score-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 6px;
    }

    .team-name {
      font-size: 13px;
      color: var(--muted);
    }

    .score-input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      padding: 10px;
      font-size: 18px;
      font-weight: 800;
      text-align: center;
      appearance: none;
      -moz-appearance: textfield;
    }

    .score-input::-webkit-outer-spin-button,
    .score-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #9ef01a, #4ed44b);
      color: #0f1a16;
      border: none;
      border-radius: 12px;
      padding: 13px 14px;
      font-weight: 800;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 14px 36px rgba(158, 240, 26, 0.22);
      transition: transform 120ms ease;
    }

    .submit-btn:active {
      transform: translateY(1px);
    }

    .tables {
      display: grid;
      gap: 12px;
    }

    .table-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .table-title {
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th, .table td {
      font-size: 13px;
      color: var(--text);
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .table th:last-child,
    .table td:last-child {
      text-align: right;
    }

    .table tr.me {
      background: rgba(158, 240, 26, 0.08);
      border-radius: 8px;
    }

    .divider {
      border: none;
      border-top: 1px dashed rgba(255, 255, 255, 0.1);
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="avatar-wrap">
      <div class="avatar" id="avatar">
        <img id="avatarImg" alt="avatar">
        <span id="avatarFallback">TG</span>
      </div>
    </div>
    <div class="names">
      <div class="display-name" id="displayName">@username</div>
      <div class="subtitle" id="positionInfo">Місце: — • Бали: —</div>
    </div>

    <div class="stats" id="stats">
      <div class="stat">
        <div class="stat-header">
          <div class="stat-label">Влучність прогнозів</div>
          <div class="stat-value" id="resultAccuracy">—%</div>
        </div>
        <div class="progress">
          <div class="progress-bar" id="resultBar"></div>
        </div>
      </div>
      <div class="stat">
        <div class="stat-header">
          <div class="stat-label">Точність по голам</div>
          <div class="stat-value" id="goalAccuracy">—%</div>
        </div>
        <div class="progress">
          <div class="progress-bar" id="goalBar"></div>
        </div>
      </div>
    </div>
    <div class="info-row" id="predictionsInline">Прогнози: —</div>
    <div class="status" id="status"></div>
    <div class="actions">
      <button class="action-btn primary active" data-tab="predict">ЗРОБИТИ ПРОГНОЗ</button>
      <button class="action-btn" data-tab="stats">СТАТИСТИКА</button>
    </div>
    <div class="tab-panel" id="tab-predict">
      <div class="panel">
        <div class="panel-title">Прогнози до 17:59 за Києвом</div>
        <div class="muted" id="predictDeadlineText">Прийом прогнозів відкрито.</div>
        <div id="predictContent" class="hidden">
          <div class="carousel" id="matchesCarousel">
            <button class="nav-btn" id="prevMatch" aria-label="Попередній матч">‹</button>
            <div class="match-card">
              <div class="match-title" id="matchTitle">Матч —</div>
              <div class="score-grid">
                <div class="score-item">
                  <div class="team-name" id="team1Name">Команда 1</div>
                  <input id="score1Input" class="score-input" type="number" min="0" max="99" inputmode="numeric" pattern="[0-9]*" placeholder="0">
                </div>
                <div class="score-item">
                  <div class="team-name" id="team2Name">Команда 2</div>
                  <input id="score2Input" class="score-input" type="number" min="0" max="99" inputmode="numeric" pattern="[0-9]*" placeholder="0">
                </div>
              </div>
              <button id="submitPrediction" class="submit-btn">Надіслати прогноз</button>
            </div>
            <button class="nav-btn" id="nextMatch" aria-label="Наступний матч">›</button>
          </div>
          <div class="muted" id="predictHelper"></div>
        </div>
        <div class="muted" id="noMatchesText">Завантаження матчів...</div>
      </div>
    </div>
    <div class="tab-panel hidden" id="tab-stats">
      <div class="panel">
        <div class="panel-title">Статистика</div>
        <div class="muted">Топ-10 та твій рядок.</div>
        <div class="tables">
          <div class="table-card">
            <div class="table-title">Таблиця балів</div>
            <div id="leaderboardTable" class="muted">Завантаження...</div>
          </div>
          <div class="table-card">
            <div class="table-title">Влучність прогнозів</div>
            <div id="resultAccuracyTable" class="muted">Завантаження...</div>
          </div>
          <div class="table-card">
            <div class="table-title">Точність по голам</div>
            <div id="goalAccuracyTable" class="muted">Завантаження...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = "https://web-production-c0d3b.up.railway.app"; // повний домен Railway
    const tg = window.Telegram?.WebApp;
    const statusEl = document.getElementById("status");
    const displayNameEl = document.getElementById("displayName");
    const positionInfoEl = document.getElementById("positionInfo");
    const predictionsInlineEl = document.getElementById("predictionsInline");
    const avatarImg = document.getElementById("avatarImg");
    const avatarFallback = document.getElementById("avatarFallback");
    const resultAccuracyEl = document.getElementById("resultAccuracy");
    const goalAccuracyEl = document.getElementById("goalAccuracy");
    const resultBar = document.getElementById("resultBar");
    const goalBar = document.getElementById("goalBar");
    const actionButtons = document.querySelectorAll(".action-btn");
    const tabPanels = {
      predict: document.getElementById("tab-predict"),
      stats: document.getElementById("tab-stats"),
    };
    const predictDeadlineText = document.getElementById("predictDeadlineText");
    const predictContent = document.getElementById("predictContent");
    const noMatchesText = document.getElementById("noMatchesText");
    const predictHelper = document.getElementById("predictHelper");
    const matchTitleEl = document.getElementById("matchTitle");
    const team1NameEl = document.getElementById("team1Name");
    const team2NameEl = document.getElementById("team2Name");
    const score1Input = document.getElementById("score1Input");
    const score2Input = document.getElementById("score2Input");
    const prevMatchBtn = document.getElementById("prevMatch");
    const nextMatchBtn = document.getElementById("nextMatch");
    const submitPredictionBtn = document.getElementById("submitPrediction");
    const leaderboardTable = document.getElementById("leaderboardTable");
    const resultAccuracyTable = document.getElementById("resultAccuracyTable");
    const goalAccuracyTable = document.getElementById("goalAccuracyTable");

    let initDataRaw = "";
    let currentUser = null;
    let matchesState = {
      list: [],
      index: 0,
      allowed: true,
      deadline: "17:59 Europe/Kyiv",
    };
    let statsLoaded = false;
    const DEADLINE_TEXT = "Прогнози приймаємо до 17:59 за Києвом.";

    function setFallbackInitials(user) {
      const first = (user.first_name || "").trim();
      const last = (user.last_name || "").trim();
      const initials = (first[0] || "") + (last[0] || "");
      avatarFallback.textContent = initials ? initials.toUpperCase() : "TG";
    }

    function getUserFromHash() {
      // location.hash може містити tgWebAppData="query_id=...&user=%7B...%7D&auth_date=...&hash=..."
      const rawHash = location.hash.startsWith("#") ? location.hash.slice(1) : location.hash;
      if (!rawHash) return null;
      const outer = new URLSearchParams(rawHash);
      const innerStr = outer.get("tgWebAppData");
      if (!innerStr) return null;
      const inner = new URLSearchParams(innerStr);
      const userStr = inner.get("user");
      if (!userStr) return null;
      try { return JSON.parse(decodeURIComponent(userStr)); } catch { return null; }
    }

    function getUser() {
      return tg?.initDataUnsafe?.user || getUserFromHash();
    }

    function getInitDataRaw() {
      if (tg?.initData) return tg.initData;
      const hash = location.hash.startsWith("#") ? location.hash.slice(1) : location.hash;
      const outer = new URLSearchParams(hash);
      return outer.get("tgWebAppData") || "";
    }

    function renderUser(user) {
      currentUser = user;
      const fullLabel = [user.first_name, user.last_name].filter(Boolean).join(" ");
      const nameLabel = fullLabel || (user.username ? `@${user.username}` : `id${user.id}`);
      displayNameEl.textContent = nameLabel;
      statusEl.textContent = "";
      predictionsInlineEl.textContent = "Прогнози: —";
      positionInfoEl.textContent = "Місце: — • Бали: —";
      resultAccuracyEl.textContent = "—%";
      goalAccuracyEl.textContent = "—%";
      resultBar.style.width = "0%";
      goalBar.style.width = "0%";
      setFallbackInitials(user);
      if (user.photo_url) {
        avatarImg.src = user.photo_url;
        avatarImg.onload = () => { avatarImg.style.display = "block"; avatarFallback.style.display = "none"; };
        avatarImg.onerror = () => { avatarImg.style.display = "none"; avatarFallback.style.display = "block"; };
      } else {
        avatarImg.style.display = "none";
        avatarFallback.style.display = "block";
      }
    }

    function switchTab(tab) {
      actionButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === tab;
        btn.classList.toggle("active", isActive);
        if (isActive && btn.dataset.tab === "predict") btn.classList.add("primary");
        if (!isActive && btn.dataset.tab === "predict") btn.classList.remove("primary");
      });
      Object.entries(tabPanels).forEach(([key, el]) => {
        el.classList.toggle("hidden", key !== tab);
      });
      if (tab === "stats") {
        ensureStatsLoaded();
      }
    }

    async function loadProfile(initData) {
      if (!initData) return;
      try {
        const res = await fetch(`${API_BASE}/api/webapp/profile`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ initData }).toString(),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "profile_failed");
        const stats = data.stats || {};
        predictionsInlineEl.textContent = `Прогнози: ${stats.predictions ?? "0"}`;
        const resultPct = Number(stats.result_accuracy_percent || 0);
        const goalPct = Number(stats.goal_accuracy_percent || 0);
        const placeVal = Number(stats.place || 0);
        const pointsVal = Number.isFinite(stats.points) ? stats.points : null;
        resultAccuracyEl.textContent = `${resultPct.toFixed(0)}%`;
        goalAccuracyEl.textContent = `${goalPct.toFixed(0)}%`;
        const placeText = placeVal > 0 ? `Місце: ${placeVal}` : "Місце: —";
        const pointsText = pointsVal !== null ? `Бали: ${pointsVal}` : "Бали: —";
        positionInfoEl.textContent = `${placeText} • ${pointsText}`;
        requestAnimationFrame(() => {
          resultBar.style.width = `${Math.min(Math.max(resultPct, 0), 100)}%`;
          goalBar.style.width = `${Math.min(Math.max(goalPct, 0), 100)}%`;
        });
      } catch (e) {
        console.error("profile error:", e);
        statusEl.textContent = "Помилка профілю: " + (e?.message || "network");
      }
    }

    function renderMatchCard() {
      const { list, index, allowed, deadline } = matchesState;
      predictDeadlineText.textContent = allowed
        ? `Прийом прогнозів відкрито до ${deadline}.`
        : DEADLINE_TEXT;

      if (!allowed) {
        predictContent.classList.add("hidden");
        noMatchesText.textContent = DEADLINE_TEXT;
        return;
      }
      if (!list.length) {
        predictContent.classList.add("hidden");
        noMatchesText.textContent = "Немає матчів для прогнозу.";
        return;
      }
      predictContent.classList.remove("hidden");
      noMatchesText.textContent = "";
      const match = list[index];
      matchTitleEl.textContent = `Матч #${match.id}`;
      team1NameEl.textContent = match.team1;
      team2NameEl.textContent = match.team2;
      if (match.predicted) {
        score1Input.value = match.pred_score1 ?? "";
        score2Input.value = match.pred_score2 ?? "";
      } else {
        score1Input.value = "";
        score2Input.value = "";
      }
      prevMatchBtn.disabled = list.length <= 1 || index === 0;
      nextMatchBtn.disabled = list.length <= 1 || index === list.length - 1;
      submitPredictionBtn.disabled = !allowed || match.predicted;
      predictHelper.textContent = match.predicted
        ? `Твій прогноз: ${match.pred_score1}:${match.pred_score2}`
        : `Матч ${index + 1} з ${list.length}`;
    }

    async function loadMatches() {
      if (!initDataRaw) return;
      noMatchesText.textContent = "Завантаження матчів...";
      try {
        const res = await fetch(`${API_BASE}/api/webapp/matches`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ initData: initDataRaw }).toString(),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "matches_failed");
        matchesState.list = data.matches || [];
        matchesState.index = 0;
        matchesState.allowed = Boolean(data.prediction_allowed);
        matchesState.deadline = data.deadline || "17:59 Europe/Kyiv";
        renderMatchCard();
      } catch (e) {
        console.error("matches error:", e);
        noMatchesText.textContent = "Не вдалося завантажити матчі.";
        statusEl.textContent = "Помилка матчів: " + (e?.message || "network");
      }
    }

    function clampScore(val) {
      const num = Number(val);
      if (!Number.isFinite(num) || num < 0) return 0;
      return Math.min(Math.round(num), 99);
    }

    async function submitCurrentPrediction() {
      if (!matchesState.allowed) {
        predictHelper.textContent = "Дедлайн минув. Спробуй завтра.";
        return;
      }
      if (!matchesState.list.length) return;
      const match = matchesState.list[matchesState.index];
      if (match.predicted) {
        predictHelper.textContent = "Ти вже робив прогноз на цей матч.";
        return;
      }
      if (score1Input.value === "" || score2Input.value === "") {
        predictHelper.textContent = "Введи рахунок для обох команд.";
        return;
      }
      const score1 = clampScore(score1Input.value);
      const score2 = clampScore(score2Input.value);
      try {
        submitPredictionBtn.disabled = true;
        const res = await fetch(`${API_BASE}/api/webapp/prediction`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            initData: initDataRaw,
            match_id: match.id,
            score1,
            score2,
          }),
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          const err = data.error || "prediction_failed";
          if (err === "already_predicted") predictHelper.textContent = "Ти вже робив прогноз на цей матч.";
          else if (err === "deadline_passed") predictHelper.textContent = "Дедлайн минув. Спробуй завтра.";
          else predictHelper.textContent = "Не вдалося зберегти прогноз.";
          return;
        }
        predictHelper.textContent = `Зберіг ${score1}:${score2} для ${match.team1} vs ${match.team2}.`;
        match.predicted = true;
        match.pred_score1 = score1;
        match.pred_score2 = score2;
        renderMatchCard();
      } catch (e) {
        console.error("prediction error:", e);
        predictHelper.textContent = "Помилка мережі. Спробуй ще раз.";
      } finally {
        submitPredictionBtn.disabled = !matchesState.allowed;
      }
    }

    function renderTable(targetEl, rows, userRow, columns) {
      targetEl.textContent = "";
      if ((!rows || !rows.length) && !userRow) {
        targetEl.textContent = "Немає даних.";
        return;
      }
      const table = document.createElement("table");
      table.className = "table";
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      columns.forEach((col) => {
        const th = document.createElement("th");
        th.textContent = col.label;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      const currentId = currentUser?.id;
      const appendRow = (row) => {
        const tr = document.createElement("tr");
        if (row.user_id === currentId) tr.classList.add("me");
        columns.forEach((col) => {
          const td = document.createElement("td");
          const value = col.format ? col.format(row) : row[col.key];
          td.textContent = value;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      };

      rows.forEach(appendRow);
      const userInTop = rows.some((r) => r.user_id === (userRow && userRow.user_id));
      if (userRow && !userInTop) {
        const divider = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = columns.length;
        td.innerHTML = "<hr class='divider'>";
        divider.appendChild(td);
        tbody.appendChild(divider);
        appendRow(userRow);
      }
      table.appendChild(tbody);
      targetEl.appendChild(table);
    }

    async function loadLeaderboard() {
      try {
        const res = await fetch(`${API_BASE}/api/webapp/leaderboard`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ initData: initDataRaw }).toString(),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "leaderboard_failed");
        renderTable(
          leaderboardTable,
          data.top || [],
          data.user,
          [
            { key: "rank", label: "#" },
            {
              key: "username",
              label: "Користувач",
              format: (row) => row.username || `id${row.user_id}`,
            },
            { key: "points", label: "Бали" },
          ]
        );
      } catch (e) {
        console.error("leaderboard error:", e);
        leaderboardTable.textContent = "Не вдалося завантажити таблицю.";
      }
    }

    async function loadResultAccuracy() {
      try {
        const res = await fetch(`${API_BASE}/api/webapp/result-accuracy`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ initData: initDataRaw }).toString(),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "result_accuracy_failed");
        renderTable(
          resultAccuracyTable,
          data.top || [],
          data.user,
          [
            { key: "rank", label: "#" },
            {
              key: "username",
              label: "Користувач",
              format: (row) => row.username || `id${row.user_id}`,
            },
            {
              key: "result_accuracy_percent",
              label: "Точність",
              format: (row) => `${Math.round(row.result_accuracy_percent)}%`,
            },
          ]
        );
      } catch (e) {
        console.error("result accuracy error:", e);
        resultAccuracyTable.textContent = "Не вдалося завантажити дані.";
      }
    }

    async function loadGoalAccuracy() {
      try {
        const res = await fetch(`${API_BASE}/api/webapp/goal-accuracy`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ initData: initDataRaw }).toString(),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "goal_accuracy_failed");
        renderTable(
          goalAccuracyTable,
          data.top || [],
          data.user,
          [
            { key: "rank", label: "#" },
            {
              key: "username",
              label: "Користувач",
              format: (row) => row.username || `id${row.user_id}`,
            },
            {
              key: "goal_accuracy_percent",
              label: "Точність",
              format: (row) => `${Math.round(row.goal_accuracy_percent)}%`,
            },
          ]
        );
      } catch (e) {
        console.error("goal accuracy error:", e);
        goalAccuracyTable.textContent = "Не вдалося завантажити дані.";
      }
    }

    async function ensureStatsLoaded() {
      if (statsLoaded || !initDataRaw) return;
      statsLoaded = true;
      await loadLeaderboard();
      await loadResultAccuracy();
      await loadGoalAccuracy();
    }

    (function boot() {
      if (!tg) {
        statusEl.textContent = "Запусти через кнопку Web App у Telegram.";
        return setFallbackInitials({});
      }
      tg.ready(); tg.expand();

      const user = getUser();

      if (!user) {
        const isMac = tg.platform === "macos";
        statusEl.textContent = isMac
          ? "Клієнт Telegram для macOS не передає user. Відкрий у мобільному Telegram або Telegram Desktop."
          : "Не бачу user у initData. Відкрий через кнопку бота (не напряму лінком).";
        return setFallbackInitials({});
      }
      renderUser(user);

      initDataRaw = getInitDataRaw();
      loadProfile(initDataRaw);
      loadMatches();
      // fetch(`${API_BASE}/api/webapp/ping`).then(r => r.json()).then(console.log).catch(console.error);

      actionButtons.forEach((btn) => {
        btn.addEventListener("click", () => switchTab(btn.dataset.tab));
      });
      prevMatchBtn.addEventListener("click", () => {
        if (matchesState.index > 0) {
          matchesState.index -= 1;
          renderMatchCard();
        }
      });
      nextMatchBtn.addEventListener("click", () => {
        if (matchesState.index < matchesState.list.length - 1) {
          matchesState.index += 1;
          renderMatchCard();
        }
      });
      submitPredictionBtn.addEventListener("click", submitCurrentPrediction);
      switchTab("predict");
    })();
  </script>
  <script>
    const DEBUG = false; // ← вимикає повідомлення в інтерфейсі

    const tgDebug = window.Telegram?.WebApp;
    const statusElDebug = document.getElementById("status");

    function showDebug(msg, extra) {
      console.log(msg, extra);
      if (DEBUG && statusElDebug) {
        statusElDebug.textContent = msg + (extra ? " " + extra : "");
      }
    }

    if (!tgDebug) {
      showDebug("Сторінка поза Telegram. Відкрий через кнопку в боті.");
    } else {
      tgDebug.ready(); tgDebug.expand();
      const sameHost = location.host === "footballistika-web.vercel.app";

      const info = `host=${location.host} tg.platform=${tgDebug.platform} initData.len=${(tgDebug.initData||"").length}`;
      if (!sameHost) showDebug("Домен не збігається з /setdomain.", info);
      else if (!tgDebug.initData || !tgDebug.initDataUnsafe?.user) showDebug("initData порожній. Перевір /setdomain і відкриття через кнопку.", info);
      else showDebug("OK: initData є.", info);
    }
  </script>
</body>
</html>
